{% extends "shop/base.html" %}

{% block content %}

    <div class="row">
        <div class="col-md-12">
            <br> <br>
            <h3 class="text-center" style="color: black;">Voici votre liste d'articles sélectionnés</h3>
            <br> <br>
            <ol class="list-group list-group-numbered" id="item-list">
                
            </ol>
        </div>
    </div>

    <div>
        <br> <br>
        <h5 class="text-center" style="color: black;">Pour commander, veuillez remplir et soumettre le formulaire ci-dessous.</h5>
        <br> <br>
    </div>

    {% if messages %}
        <div class="text-center">
            <ul class="messages">
                {% for message in messages %}
                    <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
                {% endfor %}
            </ul>
        </div>
    {% endif %}

    <div class="row">
        <div class="col-md-12">
            <form method="POST">
                {% csrf_token %}
                <input type="hidden" id="items" name="items">

               <!-- <label for="nom" class="classeLabel">Noms et prénoms</label>
                <input type="text" class="form-control classInput" id="nom" name="nom" value="{{request.user.nom}} {{request.user.prenom}}" required>

                <br>
                <label for="email" class="classeLabel">Email</label>
                <input name="email" id="email" type="email" class="form-control classInput" value="{{request.user.email}}" required>-->

                <br>
                <label for="adresse" class="classeLabel">Adresse de livraison</label>
                <input type="text" class="form-control classInput" id="adresseDeLivraison" name="adresseDeLivraison" required>
                
                <br>
                <label for="ville" class="classeLabel">Ville</label>
                <input type="text" class="form-control classInput" id="ville" name="ville" required>
                
                <br>
                <label for="pays" class="classeLabel">Pays</label>
                <select id="pays" name="pays" class="form-control classInput">
                    <option selected>Cameroun</option>
                    <!--<option>Tchad</option>
                    <option>Benin</option>
                    <option>Burkina Faso</option>-->
                </select>
                <br>
                
               <!-- <label for="tel" class="classeLabel">Numéro de téléphone</label>
                <input type="text" class="form-control classInput" id="tel" name="tel" value="{{request.user.telephone}}" required>
                <br>-->
                
                <label for="paiement" class="classeLabel">Mode de paiement</label>
                <div>
                    <br>
                    <input type="radio" id="mtn" name="paiement" value="MTN Mobile Money">
                    <label for="mtn" style="color: white;">MTN Mobile Money</label>
                </div>
                <div>
                    <br>
                    <input type="radio" id="orange" name="paiement" value="Orange Money">
                    <label for="orange" style="color: white;">Orange Money</label>
                </div>

                <br>
                <label for="total" class="classeLabel">Somme totale</label>
                <input name="total" type="text" class="form-control bg-dark text-warning" id="total1" readonly>

                <br>
                <button type="submit" class="btn btn-primary commande">Commander</button>
            </form>
        </div>
    </div>
    <br><br>
    

{% endblock %}

{% block js %}

    <script type="text/javascript">

        document.addEventListener("DOMContentLoaded", function() {
            if (localStorage.getItem('panier') == null) {
                var panier = {};
            } else {
                panier = JSON.parse(localStorage.getItem('panier'));
            }

            function updatePanierCount() {
                document.getElementById("panier").innerHTML = "Panier = " + Object.keys(panier).length;
            }

            updatePanierCount();

            function renderTable() {
                let total = 0;
                let tableString = `
                    <table>
                        <thead>
                            <tr>
                                <td>Image</td>
                                <td>Quantité</td>
                                <td>Prix</td>
                                <td>Action</td>
                            </tr>
                        </thead>
                        <tbody>
                `;

                for (let item in panier) {
                    let nom = panier[item][1];
                    let quantite = panier[item][0];
                    let prix = parseFloat(panier[item][2]);

                    let prixTotal = quantite * prix; 
                    total += prixTotal; 

                    tableString += `
                        <tr>
                            <td>
                                <div>${nom}</div>
                                <div><img src="${panier[item][3]}" style="width: 100px; height: auto;"></div>
                            </td>
                            <td>${quantite}</td>
                            <td>${prixTotal.toFixed(2)} FCFA</td>
                            <td>
                                <span><button class="btn btn-success add-quantity" data-id="${item}">Augmenter</button></span>
                                <span><button class="btn btn-danger reduce-quantity" data-id="${item}">Réduire</button></span>
                            </td>
                        </tr>
                    `;
                }

                tableString += `
                        </tbody>
                    </table>
                    <div>
                        Total: <span id="total">${total.toFixed(2)} FCFA</span>
                    </div>
                `;

                $('#item-list').html(tableString);
                updatePanierCount();
                document.getElementById('total1').value = total.toFixed(2) + " FCFA";

                $('#items').val(JSON.stringify(panier)); // Met à jour le champ caché ici
            }

            renderTable(); 

            $(document).on('click', '.reduce-quantity', function() {
                let item_id = $(this).data('id');
                if (panier[item_id]) {
                    panier[item_id][0]--; 
                    if (panier[item_id][0] <= 0) {
                        delete panier[item_id]; 
                    }
                    localStorage.setItem('panier', JSON.stringify(panier)); 
                    renderTable(); 
                }
            });

            $(document).on('click', '.add-quantity', function(){
                let item_id = $(this).data('id');
                if (panier[item_id]) {
                    panier[item_id][0]++;
                }
                localStorage.setItem('panier', JSON.stringify(panier));
                renderTable();
            });

            $(document).on('click', '.commande', function(){
                localStorage.clear()
                renderTable();
            });

            updatePanierCount();

            // Ajouter un gestionnaire d'événements pour le formulaire
            $('form').on('submit', function() {
                $('#items').val(JSON.stringify(panier)); // Met à jour le champ caché avant la soumission
            });
        });
    </script>

{% endblock %}
