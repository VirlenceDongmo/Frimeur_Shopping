{% extends "shop/base.html" %}

{% block content %}

    <div class="row">
        <div class="col-md-12">
            <br> <br>
            <h3 class="text-center" style="color: white;">Voici votre liste d'articles sélectionnés</h3>
            <br> <br>
            <ol class="list-group list-group-numbered" id="item-list">
                
            </ol>
        </div>
    </div>

    <div>
        <br> <br>
        <h5 class="text-center" style="color: white;">Pour commander, veuillez remplir et soumettre le formulaire ci-dessous.</h5>
        <br> <br>
    </div>

    <div class="row">
        <div class="col-md-12">
            <form method="POST">
                {% csrf_token %}
                <input type="hidden" id="items" name="items">
                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label for="nom" style="color: white;" class="classeLabel">Noms et prénoms</label>
                        <input type="text" class="form-control classInput" id="nom" name="nom" value="{{request.user.nom}} {{request.user.prenom}}">
                    </div>
                    <div class="form-group col-md-6">
                        <label for="email" style="color: white;" class="classeLabel">Email</label>
                        <input name="email" id="email" type="email" class="form-control classInput" value="{{request.user.email}}">
                    </div>
                </div>
                <div class="form-group">
                    <label for="adresse" style="color: white;" class="classeLabel">Adresse de livraison</label>
                    <input type="text" class="form-control classInput" id="adresseDeLivraison" name="adresseDeLivraison">
                </div>
                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label for="ville" style="color: white;" class="classeLabel">Ville</label>
                        <input type="text" class="form-control classInput" id="ville" name="ville">
                    </div>
                    <div class="form-group col-md-4">
                        <label for="pays" style="color: white;" class="classeLabel">Pays</label>
                        <select id="pays" name="pays" class="form-control classInput">
                            <option selected >Cameroun</option>
                            <!--<option>Tchad</option>
                            <option>Benin</option>
                            <option>Burkina Faso</option>-->
                        </select>
                    </div>
                    <div class="form-group col-md-6">
                        <label for="ville" style="color: white;" class="classeLabel">Numéro de téléphone</label>
                        <input type="text" class="form-control classInput" id="tel" name="tel" value="{{request.user.telephone}}">
                    </div>
                    <label for="paiement" style="color: white;" class="classeLabel">Mode de paiement</label>
                    <div class="form-control classInput">
                        <div>
                            <input type="radio" id="mtn" name="paiement" value="MTN Mobile Money">
                            <label for="mtn" style="color: black;">MTN Mobile Money</label>
                        </div>
                        <div>
                            <input type="radio" id="orange" name="paiement" value="Orange Money">
                            <label for="orange" style="color: black;">Orange Money</label>
                        </div>
                    </div>
                    <div class="form-group col-md-2">
                        <label for="total" style="color: white;" class="classeLabel">Somme totale</label>
                        <input name="total" type="text" class="form-control bg-dark text-warning" id="total1" readonly>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Commander</button>
                <br>
            </form>
        </div>
    </div>
    <br><br>
    

{% endblock %}

{% block js %}

    <script type="text/javascript">

        document.addEventListener("DOMContentLoaded", function() {
            if (localStorage.getItem('panier') == null) {
                var panier = {};
            } else {
                panier = JSON.parse(localStorage.getItem('panier'));
            }

            function updatePanierCount() {
                document.getElementById("panier").innerHTML = "Panier = " + Object.keys(panier).length;
            }

            updatePanierCount();

            function renderTable() {
                let total = 0;
                let tableString = `
                    <table>
                        <thead>
                            <tr>
                                <td>Image</td>
                                <td>Quantité</td>
                                <td>Prix</td>
                                <td>Action</td>
                            </tr>
                        </thead>
                        <tbody>
                `;

                for (let item in panier) {
                    let nom = panier[item][1];
                    let quantite = panier[item][0];
                    let prix = parseFloat(panier[item][2]);

                    let prixTotal = quantite * prix; 
                    total += prixTotal; 

                    tableString += `
                        <tr>
                            <td>
                                <div>${nom}</div>
                                <div><img src="${panier[item][3]}" style="width: 100px; height: auto;"></div>
                            </td>
                            <td>${quantite}</td>
                            <td>${prixTotal.toFixed(2)} FCFA</td>
                            <td>
                                <span><button class="btn btn-success add-quantity" data-id="${item}">Augmenter</button></span>
                                <span><button class="btn btn-danger reduce-quantity" data-id="${item}">Réduire</button></span>
                            </td>
                        </tr>
                    `;
                }

                tableString += `
                        </tbody>
                    </table>
                    <div>
                        Total: <span id="total">${total.toFixed(2)} FCFA</span>
                    </div>
                `;

                $('#item-list').html(tableString);
                updatePanierCount();
                document.getElementById('total1').value = total.toFixed(2) + " FCFA";

                $('#items').val(JSON.stringify(panier)); // Met à jour le champ caché ici
            }

            renderTable(); 

            $(document).on('click', '.reduce-quantity', function() {
                let item_id = $(this).data('id');
                if (panier[item_id]) {
                    panier[item_id][0]--; 
                    if (panier[item_id][0] <= 0) {
                        delete panier[item_id]; 
                    }
                    localStorage.setItem('panier', JSON.stringify(panier)); 
                    renderTable(); 
                }
            });

            $(document).on('click', '.add-quantity', function(){
                let item_id = $(this).data('id');
                if (panier[item_id]) {
                    panier[item_id][0]++;
                }
                localStorage.setItem('panier', JSON.stringify(panier));
                renderTable();
            });

            // Ajouter un gestionnaire d'événements pour le formulaire
            $('form').on('submit', function() {
                $('#items').val(JSON.stringify(panier)); // Met à jour le champ caché avant la soumission
            });
        });
    </script>

{% endblock %}
